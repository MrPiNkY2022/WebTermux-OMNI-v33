const express = require('express');
const http = require('http');
const https = require('https');
const fs = require('fs');
const socketio = require('socket.io');
const pty = require('node-pty');
const os = require('os');
const session = require('express-session');
const bodyParser = require('body-parser');
const config = require('./config.json');

const app = express();
const server = config.ssl ? https.createServer({
  key: fs.readFileSync('server.key'),
  cert: fs.readFileSync('server.cert')
}, app) : http.createServer(app);

const io = socketio(server);

app.use(bodyParser.urlencoded({ extended: true }));
app.use(session({
  secret: config.sessionSecret,
  resave: false,
  saveUninitialized: false
}));
app.use(express.static('public'));

// Simple login
app.get('/fs/*', (req, res) => {
  const path = req.params[0];
  fs.readdir(path, (err, files) => res.json(files));
});
io.on('connection', socket => {
  socket.on('fs-list', dir => { /* emit files */ });
  socket.on('fs-upload', (file, data) => { /* write file */ });
});


app.post('/login', (req, res) => {
  if (req.body.password === config.password) {
    req.session.authenticated = true;
    res.redirect('/terminal.html');
  } else {
    res.send('Wrong password <a href="/">Try again</a>');
  }
});

// Protect terminal
app.use('/terminal.html', (req, res, next) => {
  if (req.session.authenticated) next();
  else res.redirect('/');
});

io.use((socket, next) => {
  session(socket.request, {}, next);
});

io.on('connection', socket => {
  if (!socket.request.session.authenticated) {
    socket.disconnect();
    return;
  }

  const shell = process.env.SHELL || '/bin/bash';
  const ptyProcess = pty.spawn(shell, [], {
    name: 'xterm-color',
    cols: 80,
    rows: 30,
    cwd: process.env.HOME,
    env: process.env
  });

  ptyProcess.onData(data => socket.emit('output', data));
  socket.on('input', data => ptyProcess.write(data));
  socket.on('resize', size => ptyProcess.resize(size.cols, size.rows));

  // System monitor every 2s
  const monitor = setInterval(() => {
    const load = os.loadavg()[0];
    const mem = (1 - os.freemem() / os.totalmem()) * 100;
    const uptime = os.uptime();
    socket.emit('stats', { load, mem, uptime });
  }, 2000);

  socket.on('disconnect', () => {
    clearInterval(monitor);
    ptyProcess.kill();
  });
});

server.listen(config.port, () => console.log(`WEBTERMUX OMNI V33 running on port ${config.port}`));
